#!/bin/bash
# Simplified VNC startup script to avoid GNOME session worker crashes
set -x

# Set up proper X11 display environment for VNC session
export DISPLAY=:2
export WAYLAND_DISPLAY=""
unset WAYLAND_DISPLAY

# This script is executed by the VNC server when it creates a new session.
# The script starts the processes that constitute the music server.
# First set up the display environment, as usually done by an xstartup script.
[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
xsetroot -solid grey
vncconfig -iconic &

# Start DBUS for applications that need it
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax)
    export DBUS_SESSION_BUS_ADDRESS
fi

# Use a lightweight window manager instead of GNOME components
# Try metacity first, fall back to alternatives
if command -v metacity >/dev/null 2>&1; then
    metacity &
elif command -v openbox >/dev/null 2>&1; then
    openbox &
elif command -v xfwm4 >/dev/null 2>&1; then
    xfwm4 &
else
    # Fallback to basic window manager
    x-window-manager &
fi

# Give window manager time to start and wait for X server to be ready
sleep 2

# Wait for X server to be fully ready
for i in {1..10}; do
    if xset q >/dev/null 2>&1; then
        echo "X server is ready"
        break
    fi
    echo "Waiting for X server... ($i/10)"
    sleep 1
done

# Move to music server directory
cd "$( dirname "$0" )"
source env.sh

# At kernel boot time, Linux puts all four of the Digiface USB outputs into ADAT mode 
# (snd_usb_rme_digiface_boot_quirk()).  Set the two outputs that we use back into S/PDIF mode.
amixer -c "$DIGIFACE_USB_NAME" cset name='Output 1 Format' 'S/PDIF'
amixer -c "$DIGIFACE_USB_NAME" cset name='Output 2 Format' 'S/PDIF'

# Additional environment variables for GTK applications in VNC
export GDK_BACKEND=x11
export GTK_THEME=Adwaita

# Wait for X11 to be fully ready and test it
sleep 2
xset q > /dev/null 2>&1 || sleep 3

# Start Quod Libet music player with enhanced logging
echo "Starting QuodLibet at $(date)" >> /tmp/vnc_startup.log
./start_quodlibet &
QUODLIBET_PID=$!

# Check if QuodLibet is still running after a few seconds
sleep 5
if ! kill -0 $QUODLIBET_PID 2>/dev/null; then
    echo "QuodLibet failed to start, PID $QUODLIBET_PID exited" >> /tmp/vnc_startup.log
    # Try starting with verbose output directly
    echo "Attempting direct start with debug output" >> /tmp/vnc_startup.log
    source "$PYTHON_ENVIRONMENT/bin/activate"
    python3 $QUOD_LIBET_DIR/quodlibet.py --debug >> /tmp/quodlibet_debug.log 2>&1 &
else
    echo "QuodLibet started successfully with PID $QUODLIBET_PID" >> /tmp/vnc_startup.log
fi

# Start camilladsp.  It will error out if there is nothing connected to the input side
# of the ALSA loopback device, so delay a while to give quod libet time to finish
# starting up. 
sleep 10
./start_camilladsp &

# Start camilladsp backend server.
./start_camilladsp_backend &

# Start Firefox, showing the camilladsp GUI.
# The snap version of Firefox does not work well without a real GNOME session,
# so use the conventional install directly from Mozilla.  See the install script.
firefox  http://localhost:5005/gui/index.html &

xterm -geometry 80x6+0+0

